<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apilesbordes - Miel artisanal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #fffbee;
      color: #333;
    }
    header {
      background: #f6c90e;
      padding: 20px;
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: #3e2f00;
    }
    section {
      padding: 20px;
      text-align: center;
    }
    .products {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      justify-items: center;
    }
    @media(max-width: 900px) {
      .products {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media(max-width: 600px) {
      .products {
        grid-template-columns: 1fr;
      }
    }
    .product {
      background: #fff8d9;
      border-radius: 12px;
      padding: 20px;
      width: 100%;
      max-width: 280px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .product img {
      max-width: 100%;
      border-radius: 12px;
      margin-bottom: 10px;
    }
    .product h3 {
      margin-bottom: 5px;
    }
    .qty {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    #cart {
      background: #fff8d9;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      margin: 20px auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: left;
    }
    #cart h2 {
      text-align: center;
    }
    #cart table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    #cart table th, #cart table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    footer {
      text-align: center;
      padding: 20px;
      background: #f6c90e;
      margin-top: 20px;
    }
    /* --- Formulaire bien align√© --- */
    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 500px;
      margin: 0 auto;
      text-align: left;
    }
    form label {
      font-weight: bold;
      margin-top: 6px;
    }
    form input, form textarea, form select, form button {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
      width: 100%;
      box-sizing: border-box;
    }
    form button {
      background: #f6c90e;
      color: #3e2f00;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    form button:hover {
      background: #e0b800;
    }
    .relay-item {
      padding: 6px;
      border: 1px solid #ccc;
      margin-bottom: 4px;
      cursor: pointer;
      border-radius: 6px;
    }
    .relay-item:hover {
      background: #f6c90e33;
    }
    #relay-chosen {
      margin-top: 8px;
      font-weight: bold;
      color: green;
    }
  </style>
</head>
<body>

<header>üçØ Apilesbordes - Miel artisanal</header>

<section>
  <h2>Nos miels</h2>
  <p>Miels 100% naturels, r√©colt√©s avec passion en Sologne et en For√™t.</p>
</section>

<!-- ================= MIEL DE SOLOGNE ================= -->
<section>
  <h2>üçØ Miel de Sologne</h2>
  <div class="products">
    <div class="product">
      <h3>Pot 250g</h3>
      <img src="images/miel_sologne_250.jpg" alt="Miel de Sologne 250g">
      <label>Quantit√© :</label>
      <select class="qty" data-name="Miel de Sologne 250g" data-weight="0.385" data-price="5">
        <option value="0">-- S√©lectionnez --</option>
        <option value="1">1 pot ‚Äì 5 ‚Ç¨</option>
        <option value="2">2 pots ‚Äì 10 ‚Ç¨</option>
        <option value="3">3 pots ‚Äì 15 ‚Ç¨</option>
      </select>
    </div>
    <div class="product">
      <h3>Pot 500g</h3>
      <img src="images/miel_sologne_500.jpg" alt="Miel de Sologne 500g">
      <label>Quantit√© :</label>
      <select class="qty" data-name="Miel de Sologne 500g" data-weight="0.682" data-price="7">
        <option value="0">-- S√©lectionnez --</option>
        <option value="1">1 pot ‚Äì 7 ‚Ç¨</option>
        <option value="2">2 pots ‚Äì 14 ‚Ç¨</option>
        <option value="3">3 pots ‚Äì 21 ‚Ç¨</option>
      </select>
    </div>
    <div class="product">
      <h3>Pot 1kg</h3>
      <img src="images/miel_sologne_1kg.jpg" alt="Miel de Sologne 1kg">
      <label>Quantit√© :</label>
      <select class="qty" data-name="Miel de Sologne 1kg" data-weight="1.320" data-price="13">
        <option value="0">-- S√©lectionnez --</option>
        <option value="1">1 pot ‚Äì 13 ‚Ç¨</option>
        <option value="2">2 pots ‚Äì 26 ‚Ç¨</option>
        <option value="3">3 pots ‚Äì 39 ‚Ç¨</option>
      </select>
    </div>
  </div>
</section>

<!-- ================= MIEL DE FOR√äT ================= -->
<section>
  <h2>üå≤ Miel de For√™t</h2>
  <div class="products">
    <div class="product">
      <h3>Pot 250g</h3>
      <img src="images/miel_foret_250.jpg" alt="Miel de For√™t 250g">
      <label>Quantit√© :</label>
      <select class="qty" data-name="Miel de For√™t 250g" data-weight="0.385" data-price="5">
        <option value="0">-- S√©lectionnez --</option>
        <option value="1">1 pot ‚Äì 5 ‚Ç¨</option>
        <option value="2">2 pots ‚Äì 10 ‚Ç¨</option>
        <option value="3">3 pots ‚Äì 15 ‚Ç¨</option>
      </select>
    </div>
    <div class="product">
      <h3>Pot 500g</h3>
      <img src="images/miel_foret_500.jpg" alt="Miel de For√™t 500g">
      <label>Quantit√© :</label>
      <select class="qty" data-name="Miel de For√™t 500g" data-weight="0.682" data-price="7">
        <option value="0">-- S√©lectionnez --</option>
        <option value="1">1 pot ‚Äì 7 ‚Ç¨</option>
        <option value="2">2 pots ‚Äì 14 ‚Ç¨</option>
        <option value="3">3 pots ‚Äì 21 ‚Ç¨</option>
      </select>
    </div>
    <div class="product">
      <h3>Pot 1kg</h3>
      <img src="images/miel_foret_1kg.jpg" alt="Miel de For√™t 1kg">
      <label>Quantit√© :</label>
      <select class="qty" data-name="Miel de For√™t 1kg" data-weight="1.320" data-price="13">
        <option value="0">-- S√©lectionnez --</option>
        <option value="1">1 pot ‚Äì 13 ‚Ç¨</option>
        <option value="2">2 pots ‚Äì 26 ‚Ç¨</option>
        <option value="3">3 pots ‚Äì 39 ‚Ç¨</option>
      </select>
    </div>
  </div>
</section>

<!-- ================= PANIER ================= -->
<section id="cart">
  <h2>üõí Mon Panier</h2>
  <table id="cart-table">
    <thead>
      <tr>
        <th>Produit</th>
        <th>Qt√©</th>
        <th>Prix</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p><strong>Total Produits :</strong> <span id="total-produit">0 ‚Ç¨</span></p>
  <p><strong>Frais de livraison :</strong> <span id="frais-livraison">0 ‚Ç¨</span></p>
  <p><strong>Total √† payer :</strong> <span id="total-general">0 ‚Ç¨</span></p>
</section>

<!-- ================= LIVRAISON & PAIEMENT ================= -->
<section id="options-livraison" class="cart">
  <h2>Livraison & Paiement</h2>
  <label for="livraison-select">Mode de livraison :</label>
  <select id="livraison-select">
    <option value="retrait">Retrait (0 ‚Ç¨)</option>
    <option value="colissimo">Colissimo (domicile)</option>
    <option value="relay">Mondial Relay - Point Relais</option>
    <option value="locker">Mondial Relay - Locker</option>
  </select>

  <p id="relay-hint" style="color:red; font-weight:bold; display:block; margin-top:8px;">
    S√©lectionnez un mode Mondial Relay pour rechercher votre point relais
  </p>
  <div id="relay-search" style="display:none; margin-top:10px;">
    <label for="cp">Code postal :</label>
    <input type="text" id="cp" placeholder="75001" style="width:130px; display:inline-block; margin-right:8px;">
    <button type="button" onclick="searchRelay()">Rechercher un point relais</button>
    <div id="relay-results" class="relay-list" style="margin-top:8px;"></div>
    <div id="relay-chosen"></div>
  </div>

  <p id="livraison-note" style="margin-top:12px;"></p>
  <div id="paypal-area" style="margin-top:16px;"></div>
</section>

<!-- ================= FORMULAIRE FINAL ================= -->
<section class="cart" id="form-section" style="margin-bottom:40px;">
  <h2>üì¶ Confirmer la commande</h2>
  <form id="order-form" action="https://formspree.io/f/mrbajnvb" method="POST" onsubmit="return validateBeforeSubmit();">
    <label for="name">Nom et pr√©nom :</label>
    <input type="text" id="name" name="name" required>
    <label for="address">Adresse compl√®te (ou vide si retrait / point relais) :</label>
    <textarea id="address" name="address" rows="3"></textarea>
    <label for="email">Adresse email :</label>
    <input type="email" id="email" name="_replyto" required>
    <label for="phone">T√©l√©phone :</label>
    <input type="tel" id="phone" name="phone">
    <label for="relay-field">Point relais choisi (si Mondial Relay) :</label>
    <input type="text" id="relay-field" name="relay" placeholder="S√©lectionnez un point relais ou saisissez manuellement">
    <label for="products-field">Produits command√©s :</label>
    <textarea id="products-field" name="produits" rows="4" readonly></textarea>
    <input type="hidden" id="hidden-total" name="total">
    <input type="hidden" id="hidden-poids" name="poids_kg">
    <button type="submit">Envoyer la commande (Formulaire)</button>
  </form>
  <p class="note" style="margin-top:10px;">Remarque : le paiement se fait via PayPal ci-dessus. Le formulaire est pour r√©cup√©rer l'adresse/point relais. Si vous payez, merci de remplir le formulaire apr√®s le paiement si n√©cessaire.</p>
</section>

<footer>
  <p>üìç Les Bordes 45460 ‚Ä¢ üìß apilesbordes@hotmail.com ‚Ä¢ üìû 0651721612</p>
  <p>¬© 2025 Apilesbordes - Tous droits r√©serv√©s</p>
</footer>

<script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR"></script>
<script>
/* ====== LOGIQUE PANIER / LIVRAISON / PAYPAL ====== */
const MAX_WEIGHT_GR = 10000; // 10 kg max
function getProductSelects() {
  return Array.from(document.querySelectorAll('.qty'));
}
let currentTotal = 0;
let currentWeightGr = 0;

function updateAllDisplays() {
  const selects = getProductSelects();
  const tbody = document.querySelector('#cart-table tbody');
  tbody.innerHTML = '';
  let totalProd = 0;
  let totalWeight = 0;
  let produitsList = [];
  selects.forEach(sel => {
    const qty = parseInt(sel.value) || 0;
    if (qty > 0) {
      const name = sel.dataset.name;
      const price = parseFloat(sel.dataset.price);
      const weightKg = parseFloat(sel.dataset.weight);
      const linePrice = qty * price;
      const lineWeightGr = Math.round(qty * weightKg * 1000);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td>${qty}</td><td>${linePrice.toFixed(2)} ‚Ç¨</td>`;
      tbody.appendChild(tr);
      totalProd += linePrice;
      totalWeight += lineWeightGr;
      produitsList.push(`${qty} √ó ${name} (${linePrice.toFixed(2)} ‚Ç¨)`);
    }
  });
  currentTotal = totalProd;
  currentWeightGr = totalWeight;
  document.getElementById('total-produit').innerText = totalProd.toFixed(2) + ' ‚Ç¨';
  document.getElementById('frais-livraison').innerText = '‚Äî';
  document.getElementById('total-general').innerText = totalProd.toFixed(2) + ' ‚Ç¨';
  document.getElementById('products-field').value = produitsList.length ? produitsList.join("\n") : 'Aucun produit s√©lectionn√©';
  document.getElementById('hidden-poids').value = (totalWeight/1000).toFixed(3);
  calculateShippingAndRenderPayPal(totalProd, totalWeight);
}

function calculateShippingAndRenderPayPal(totalProd, weightGr) {
  const mode = document.getElementById('livraison-select').value;
  let frais = 0;
  let blocked = false;

  if (mode === 'retrait') {
    frais = 0;
  } else if (mode === 'colissimo') {
    if (weightGr === 0) frais = 0;
    else if (weightGr <= 250) frais = 5.25;
    else if (weightGr <= 500) frais = 7.35;
    else if (weightGr <= 750) frais = 8.65;
    else if (weightGr <= 1000) frais = 9.40;
    else if (weightGr <= 2000) frais = 10.70;
    else if (weightGr <= 5000) frais = 16.60;
    else frais = -1;
  } else if (mode === 'relay') {
    if (weightGr <= 250) frais = 4.20;
    else if (weightGr <= 500) frais = 4.49;
    else if (weightGr <= 750) frais = 5.69;
    else if (weightGr <= 1000) frais = 5.69;
    else if (weightGr <= 2000) frais = 6.99;
    else if (weightGr <= 3000) frais = 7.69;
    else if (weightGr <= 4000) frais = 9.29;
    else if (weightGr <= 5000) frais = 12.99;
    else frais = -1;
  } else if (mode === 'locker') {
    if (weightGr <= 250) frais = 3.99;
    else if (weightGr <= 500) frais = 3.99;
    else if (weightGr <= 750) frais = 4.20;
    else if (weightGr <= 1000) frais = 4.20;
    else if (weightGr <= 2000) frais = 6.20;
    else if (weightGr <= 3000) frais = 6.99;
    else if (weightGr <= 4000) frais = 7.99;
    else if (weightGr <= 5000) frais = 10.99;
    else frais = -1;
  }

  const fraisEl = document.getElementById('frais-livraison');
  const totalGenEl = document.getElementById('total-general');
  const livraisonNote = document.getElementById('livraison-note');
  if (frais === -1) {
    fraisEl.innerText = "‚ö†Ô∏è Poids trop √©lev√© ‚Äî Me contacter pour devis sp√©cial";
    totalGenEl.innerText = totalProd.toFixed(2) + ' ‚Ç¨';
    livraisonNote.innerText = "Le poids d√©passe la limite pr√©vue.";
    blocked = true;
  } else {
    fraisEl.innerText = frais.toFixed(2) + ' ‚Ç¨';
    const totalAll = totalProd + frais;
    totalGenEl.innerText = totalAll.toFixed(2) + ' ‚Ç¨';
    livraisonNote.innerText = (weightGr > 0) ? `Poids total : ${(weightGr/1000).toFixed(3)} kg` : '';
  }
  document.getElementById('hidden-total').value = (totalProd + (frais>0?frais:0)).toFixed(2);
  renderPayPalButton(!blocked && (totalProd + (frais>0?frais:0)) > 0 ? (totalProd + (frais>0?frais:0)) : 0, blocked);
}

function renderPayPalButton(amount, blocked) {
  const container = document.getElementById('paypal-area');
  container.innerHTML = '';
  if (blocked || amount <= 0) return;
  paypal.Buttons({
    createOrder: (data, actions) => actions.order.create({
      purchase_units: [{ amount: { value: amount.toFixed(2), currency_code: "EUR" } }]
    }),
    onApprove: (data, actions) => actions.order.capture().then(details => {
      alert("Paiement confirm√© ‚Äî merci " + (details.payer.name?.given_name || "") + " !");
    }),
    onError: err => {
      console.error("PayPal error", err);
      alert("Erreur lors du paiement PayPal.");
    }
  }).render('#paypal-area');
}

async function searchRelay() {
  const cp = document.getElementById('cp').value.trim();
  const resultsEl = document.getElementById('relay-results');
  const chosenEl = document.getElementById('relay-chosen');
  resultsEl.innerHTML = "Recherche...";
  chosenEl.innerHTML = "";
  if (!/^[0-9]{5}$/.test(cp)) {
    resultsEl.innerHTML = "Code postal invalide (5 chiffres).";
    return;
  }
  try {
    const resp = await fetch("https://apilesbordes.synology.me/mondialrelay.php?cp=" + encodeURIComponent(cp));
    if (!resp.ok) throw new Error("Erreur r√©seau");
    const data = await resp.json();
    if (!data || !data.length) {
      resultsEl.innerHTML = "Aucun relais trouv√©.";
      return;
    }
    resultsEl.innerHTML = "";
    data.forEach(item => {
      const div = document.createElement('div');
      div.className = 'relay-item';
      div.textContent = `${item.nom} ‚Äì ${item.adresse}, ${item.cp} ${item.ville}`;
      div.addEventListener('click', () => {
        document.getElementById('relay-field').value = div.textContent;
        chosenEl.innerHTML = "‚úÖ Point choisi : " + div.textContent;
        resultsEl.innerHTML = "";
      });
      resultsEl.appendChild(div);
    });
  } catch (e) {
    console.error(e);
    resultsEl.innerHTML = "Impossible de charger la liste automatique.<br>Merci de saisir manuellement votre point relais ci-dessous :";
  }
}

function validateBeforeSubmit() {
  const productText = document.getElementById('products-field').value || '';
  if (productText.trim() === '' || productText.trim() === 'Aucun produit s√©lectionn√©') {
    alert("Veuillez s√©lectionner au moins un produit.");
    return false;
  }
  const mode = document.getElementById('livraison-select').value;
  const address = document.getElementById('address').value.trim();
  const relayField = document.getElementById('relay-field').value.trim();
  if (mode === 'colissimo' && address.length < 5) {
    alert("Pour Colissimo, merci de saisir une adresse compl√®te.");
    return false;
  }
  if ((mode === 'relay' || mode === 'locker') && relayField.length < 3) {
    alert("Merci de choisir ou saisir un point relais/locker.");
    return false;
  }
  return true;
}

function toggleRelayUI() {
  const mode = document.getElementById('livraison-select').value;
  const relaySearchDiv = document.getElementById('relay-search');
  const relayHint = document.getElementById('relay-hint');
  if (mode === 'relay' || mode === 'locker') {
    relaySearchDiv.style.display = 'block';
    relayHint.style.display = 'none';
  } else {
    relaySearchDiv.style.display = 'none';
    relayHint.style.display = 'block';
  }
  updateAllDisplays();
}

document.getElementById('livraison-select').addEventListener('change', toggleRelayUI);
getProductSelects().forEach(sel => sel.addEventListener('change', updateAllDisplays));
toggleRelayUI();
updateAllDisplays();
</script>
</body>
</html>
